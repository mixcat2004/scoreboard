<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#e8c84a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="è¨ˆåˆ†æ¿">
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<title>å››äººè¨ˆåˆ†æ¿</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;600&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --border: #2a2a3a;
    --accent: #e8c84a;
    --neg: #e85a4a;
    --pos: #4ae8a0;
    --text: #e8e8f0;
    --muted: #666680;
    --blue: #4a8ae8;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bot: env(safe-area-inset-bottom, 0px);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  html, body {
    height: 100%;
    overscroll-behavior: none;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    min-height: 100vh;
    padding: calc(var(--safe-top) + 16px) 14px calc(var(--safe-bot) + 20px);
  }

  /* â”€â”€ HEADER â”€â”€ */
  .app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
  }

  h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(1.8rem, 5vw, 3rem);
    letter-spacing: 4px;
    color: var(--accent);
    text-shadow: 0 0 30px rgba(232,200,74,0.3);
    line-height: 1;
  }

  .header-actions { display: flex; gap: 6px; }

  .icon-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--muted);
    width: 38px; height: 38px;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }

  .icon-btn:hover, .icon-btn:active { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ INSTALL BANNER â”€â”€ */
  .install-banner {
    max-width: 900px;
    margin: 0 auto 16px;
    background: rgba(232,200,74,0.1);
    border: 1px solid rgba(232,200,74,0.3);
    border-radius: 8px;
    padding: 10px 14px;
    display: none;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    color: var(--accent);
  }

  .install-banner.show { display: flex; }
  .install-banner button {
    background: var(--accent); border: none; color: #000;
    font-family: 'Bebas Neue', sans-serif;
    letter-spacing: 1px; padding: 6px 14px; border-radius: 4px;
    cursor: pointer; white-space: nowrap; margin-left: auto;
  }

  /* â”€â”€ SCOREBOARD â”€â”€ */
  .scoreboard {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 16px;
    max-width: 900px;
    margin-left: auto; margin-right: auto;
  }

  .player-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 8px;
    text-align: center;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
  }

  .player-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 3px;
    background: var(--accent); opacity: 0.4;
    transition: all 0.3s;
  }

  .player-card.winner-highlight { border-color: var(--pos); }
  .player-card.winner-highlight::before { background: var(--pos); opacity: 1; }

  .player-name-display {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(1rem, 3.5vw, 1.4rem);
    letter-spacing: 2px;
    color: var(--accent);
    margin-bottom: 4px;
    cursor: pointer;
  }

  .player-total {
    font-size: clamp(1.3rem, 4vw, 1.8rem);
    font-weight: 600;
    transition: color 0.3s;
  }

  .player-total.pos { color: var(--pos); }
  .player-total.neg { color: var(--neg); }
  .player-total.zero { color: var(--muted); }

  .player-rounds { margin-top: 4px; font-size: 9px; color: var(--muted); letter-spacing: 1px; }

  /* â”€â”€ INPUT SECTION â”€â”€ */
  .input-section {
    max-width: 900px;
    margin: 0 auto 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 18px 14px;
  }

  .section-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 3px;
    color: var(--muted);
    margin-bottom: 6px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 8px;
  }

  .hint { font-size: 10px; color: var(--muted); letter-spacing: 1px; margin-bottom: 14px; }

  /* â”€â”€ VOICE â”€â”€ */
  .voice-area {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 14px;
    padding: 10px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
  }

  .voice-btn {
    background: transparent;
    border: 1px solid var(--blue);
    color: var(--blue);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    letter-spacing: 1px;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex; align-items: center; gap: 6px;
  }

  .voice-btn:active { opacity: 0.7; }

  .voice-btn.recording {
    background: rgba(232,90,74,0.15);
    border-color: var(--neg); color: var(--neg);
    animation: pulse 1s infinite;
  }

  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }

  .voice-status { font-size: 10px; color: var(--muted); letter-spacing: 1px; flex: 1; line-height: 1.4; }
  .voice-status.active { color: var(--blue); }
  .voice-status.error { color: var(--neg); }
  .voice-status.success { color: var(--pos); }

  /* â”€â”€ SCORE INPUTS â”€â”€ */
  .score-inputs {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 10px;
  }

  .score-field { display: flex; flex-direction: column; gap: 5px; }

  .score-field label {
    font-size: 10px; letter-spacing: 2px;
    color: var(--muted); text-align: center;
  }

  .score-field input {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    font-size: clamp(0.9rem, 3vw, 1.1rem);
    font-weight: 600;
    padding: 10px 4px;
    text-align: center;
    width: 100%; outline: none;
    transition: border-color 0.2s, color 0.2s, background 0.2s;
    -webkit-appearance: none;
  }

  .score-field input:focus { border-color: var(--accent); }
  .score-field input.is-neg { color: var(--neg); }
  .score-field input.is-winner {
    color: var(--pos); border-color: var(--pos);
    background: rgba(74,232,160,0.05); cursor: not-allowed;
  }

  .error-msg {
    font-size: 11px; color: var(--neg);
    text-align: center; margin-bottom: 8px;
    letter-spacing: 1px; min-height: 14px;
  }

  .balance-preview {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 6px; padding: 12px;
    margin-bottom: 14px; text-align: center;
  }

  .balance-label { font-size: 10px; color: var(--muted); letter-spacing: 2px; margin-bottom: 5px; }
  .balance-equation { font-size: 12px; color: var(--text); letter-spacing: 1px; line-height: 1.5; }
  .balance-equation .winner-name { color: var(--pos); font-weight: 600; }
  .balance-equation .win-score { color: var(--pos); font-weight: 600; font-size: 1.1rem; }

  .btn-add {
    width: 100%; background: var(--accent); border: none; border-radius: 8px;
    color: #000; font-family: 'Bebas Neue', sans-serif;
    font-size: 1.2rem; letter-spacing: 3px;
    padding: 14px; cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
  }

  .btn-add:active { transform: scale(0.98); }
  .btn-add:disabled { opacity: 0.3; cursor: not-allowed; }

  /* â”€â”€ HISTORY â”€â”€ */
  .history-section { max-width: 900px; margin: 0 auto; }

  .history-header {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem; letter-spacing: 3px; color: var(--muted);
    margin-bottom: 10px;
    display: flex; justify-content: space-between; align-items: center;
  }

  .export-btns { display: flex; gap: 6px; }

  .export-btn {
    background: transparent; border: 1px solid var(--border);
    color: var(--muted); font-family: 'IBM Plex Mono', monospace;
    font-size: 10px; letter-spacing: 1px;
    padding: 6px 10px; border-radius: 4px; cursor: pointer;
    transition: all 0.2s;
  }

  .export-btn:hover { border-color: var(--pos); color: var(--pos); }

  .history-table { width: 100%; border-collapse: collapse; font-size: 11px; }

  .history-table th {
    background: var(--surface); border: 1px solid var(--border);
    color: var(--muted); letter-spacing: 1px;
    padding: 8px 6px; text-align: center;
  }

  .history-table td {
    border: 1px solid var(--border); padding: 8px 6px;
    text-align: center; background: var(--bg);
  }

  .history-table tr:hover td { background: var(--surface); }

  .val-pos { color: var(--pos); font-weight: 600; }
  .val-neg { color: var(--neg); }
  .val-zero { color: var(--muted); }
  .round-num { color: var(--muted); font-size: 9px; }

  .empty-msg {
    text-align: center; color: var(--muted); font-size: 11px;
    letter-spacing: 2px; padding: 28px;
    border: 1px solid var(--border); border-radius: 8px;
  }

  /* â”€â”€ MODAL â”€â”€ */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.75); z-index: 200;
    align-items: center; justify-content: center;
    padding: 20px;
  }

  .modal-overlay.show { display: flex; }

  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 24px; width: 100%; max-width: 400px;
  }

  .modal h3 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem; letter-spacing: 3px; color: var(--accent);
    margin-bottom: 20px;
  }

  .modal-field { margin-bottom: 14px; }

  .modal-field label {
    font-size: 10px; letter-spacing: 2px; color: var(--muted);
    display: block; margin-bottom: 6px;
  }

  .modal-field input {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 6px; color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1rem; padding: 10px 12px; width: 100%; outline: none;
  }

  .modal-field input:focus { border-color: var(--accent); }

  .modal-btns { display: flex; gap: 10px; margin-top: 18px; }

  .modal-btn {
    flex: 1; padding: 12px; border-radius: 6px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem; letter-spacing: 2px; cursor: pointer;
    transition: opacity 0.2s;
  }

  .modal-btn.confirm { background: var(--accent); border: none; color: #000; }
  .modal-btn.cancel { background: transparent; border: 1px solid var(--border); color: var(--muted); }
  .modal-btn:active { opacity: 0.7; }

  /* â”€â”€ TOAST â”€â”€ */
  .toast {
    position: fixed; bottom: calc(var(--safe-bot) + 24px); left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 12px 20px;
    font-size: 12px; letter-spacing: 1px; color: var(--text);
    transition: transform 0.3s ease; z-index: 300;
    white-space: nowrap;
  }

  .toast.show { transform: translateX(-50%) translateY(0); }

  @media (max-width: 480px) {
    .scoreboard { gap: 6px; }
    .player-card { padding: 10px 6px; }
    .score-inputs { gap: 6px; }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="app-header">
  <h1>SCORE BOARD</h1>
  <div class="header-actions">
    <button class="icon-btn" onclick="openNameModal()" title="ä¿®æ”¹å§“å">âœï¸</button>
    <button class="icon-btn" onclick="showExportMenu()" title="åŒ¯å‡º">ğŸ“¥</button>
    <button class="icon-btn" onclick="confirmReset()" title="æ¸…é™¤">ğŸ—‘</button>
  </div>
</div>

<!-- PWA å®‰è£æç¤º -->
<div class="install-banner" id="installBanner">
  <span>ğŸ“± å®‰è£åˆ°æ‰‹æ©Ÿæ¡Œé¢ï¼Œåƒ App ä¸€æ¨£ä½¿ç”¨</span>
  <button onclick="installPWA()">å®‰è£</button>
</div>

<!-- ç¸½åˆ†å¡ -->
<div class="scoreboard" id="scoreboard"></div>

<!-- è¼¸å…¥å€ -->
<div class="input-section">
  <div class="section-title">æ–°å¢ä¸€å±€</div>
  <p class="hint">è¼¸å…¥ä¸‰ä½è² åˆ†ï¼Œç•™ç©ºä¸€ä½è‡ªå‹•æˆç‚ºè´å®¶</p>

  <div class="voice-area">
    <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">ğŸ¤ èªéŸ³</button>
    <div class="voice-status" id="voiceStatus">é»éº¥å…‹é¢¨èªªï¼šã€Œdon è² 10 phil è² 20 anja è² 30ã€</div>
  </div>

  <div class="score-inputs" id="scoreInputs"></div>
  <div class="error-msg" id="errorMsg"></div>

  <div class="balance-preview">
    <div class="balance-label">æœƒè¨ˆå¹³è¡¡é è¦½</div>
    <div class="balance-equation" id="balanceEq">â€”</div>
  </div>

  <button class="btn-add" id="btnAdd" onclick="addRound()" disabled>ç¢ºèªæ–°å¢</button>
</div>

<!-- æ­·å²è¨˜éŒ„ -->
<div class="history-section">
  <div class="history-header">
    <span>æ­·å²è¨˜éŒ„</span>
    <div class="export-btns">
      <button class="export-btn" onclick="exportCSV()">CSV</button>
      <button class="export-btn" onclick="exportText()">TXT</button>
    </div>
  </div>
  <div id="historyContainer"></div>
</div>

<!-- ä¿®æ”¹å§“å Modal -->
<div class="modal-overlay" id="nameModal">
  <div class="modal">
    <h3>ä¿®æ”¹ç©å®¶å§“å</h3>
    <div id="nameFields"></div>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="closeModal('nameModal')">å–æ¶ˆ</button>
      <button class="modal-btn confirm" onclick="saveNames()">ç¢ºèª</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€ ç‹€æ…‹ï¼ˆlocalStorage æŒä¹…åŒ–ï¼‰â”€â”€
let players = JSON.parse(localStorage.getItem('players') || '["don","phil","anja","arjar"]');
let totals = JSON.parse(localStorage.getItem('totals') || '[0,0,0,0]');
let history = JSON.parse(localStorage.getItem('history') || '[]');

function save() {
  localStorage.setItem('players', JSON.stringify(players));
  localStorage.setItem('totals', JSON.stringify(totals));
  localStorage.setItem('history', JSON.stringify(history));
}

// â”€â”€ PWA å®‰è£ â”€â”€
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installBanner').classList.add('show');
});

window.addEventListener('appinstalled', () => {
  document.getElementById('installBanner').classList.remove('show');
  showToast('âœ… å·²å®‰è£åˆ°æ¡Œé¢ï¼');
});

function installPWA() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(r => {
      deferredPrompt = null;
      document.getElementById('installBanner').classList.remove('show');
    });
  }
}

// â”€â”€ Service Worker â”€â”€
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}

// â”€â”€ åˆå§‹åŒ– â”€â”€
function init() {
  renderScoreboard();
  renderInputs();
  renderHistory();
  initVoice();
}

// â”€â”€ ç¸½åˆ†å¡ â”€â”€
function renderScoreboard() {
  document.getElementById('scoreboard').innerHTML = players.map((p, i) => `
    <div class="player-card" id="card-${i}">
      <div class="player-name-display" onclick="quickEditName(${i})" id="name-${i}">${p}</div>
      <div class="player-total ${totals[i]>0?'pos':totals[i]<0?'neg':'zero'}" id="total-${i}">
        ${totals[i]>0?'+':''}${totals[i]}
      </div>
      <div class="player-rounds" id="rounds-${i}">${history.length} å±€</div>
    </div>
  `).join('');
}

// â”€â”€ è¼¸å…¥æ¬„ä½ â”€â”€
function renderInputs() {
  document.getElementById('scoreInputs').innerHTML = players.map((p, i) => `
    <div class="score-field">
      <label>${p.toUpperCase()}</label>
      <input type="number" id="inp-${i}" placeholder="è² åˆ†" step="1"
        oninput="updatePreview()" inputmode="numeric">
    </div>
  `).join('');
}

// â”€â”€ å³æ™‚é è¦½ â”€â”€
function updatePreview() {
  const errorEl = document.getElementById('errorMsg');
  const eqEl = document.getElementById('balanceEq');
  const btnAdd = document.getElementById('btnAdd');

  players.forEach((_, i) => {
    document.getElementById('card-' + i).classList.remove('winner-highlight');
    const inp = document.getElementById('inp-' + i);
    inp.classList.remove('is-neg', 'is-winner');
    inp.readOnly = false;
  });

  errorEl.textContent = '';
  btnAdd.disabled = true;
  eqEl.textContent = 'â€”';

  let emptyIdx = [], filledIdx = [], vals = {};

  players.forEach((_, i) => {
    const raw = document.getElementById('inp-' + i).value.trim();
    if (raw === '') emptyIdx.push(i);
    else { vals[i] = parseInt(raw); filledIdx.push(i); }
  });

  if (emptyIdx.length !== 1) {
    eqEl.textContent = emptyIdx.length > 1 ? 'è«‹è¼¸å…¥ä¸‰ä½è² åˆ†ï¼Œç•™ç©ºä¸€ä½ç‚ºè´å®¶' : 'è«‹ç•™ç©ºä¸€ä½æ¬„ä½ä½œç‚ºè´å®¶';
    return;
  }

  for (const i of filledIdx) {
    if (isNaN(vals[i]) || vals[i] >= 0) {
      errorEl.textContent = `${players[i].toUpperCase()} å¿…é ˆè¼¸å…¥è² æ•¸ï¼`;
      return;
    }
  }

  const winIdx = emptyIdx[0];
  const negSum = filledIdx.reduce((a, i) => a + vals[i], 0);
  const winScore = -negSum;

  filledIdx.forEach(i => document.getElementById('inp-' + i).classList.add('is-neg'));
  const winInp = document.getElementById('inp-' + winIdx);
  winInp.value = winScore;
  winInp.classList.add('is-winner');
  winInp.readOnly = true;
  document.getElementById('card-' + winIdx).classList.add('winner-highlight');

  const negParts = filledIdx.map(i => `${players[i]}(${vals[i]})`).join(' + ');
  eqEl.innerHTML = `${negParts} + <span class="winner-name">${players[winIdx]}</span>(<span class="win-score">+${winScore}</span>) = 0`;
  btnAdd.disabled = false;
}

// â”€â”€ æ–°å¢ä¸€å±€ â”€â”€
function addRound() {
  const round = players.map((_, i) => parseInt(document.getElementById('inp-' + i).value) || 0);
  players.forEach((_, i) => { totals[i] += round[i]; });
  history.push(round);
  save();

  players.forEach((_, i) => document.getElementById('card-' + i).classList.remove('winner-highlight'));
  renderScoreboard();
  renderInputs();
  document.getElementById('balanceEq').textContent = 'â€”';
  document.getElementById('btnAdd').disabled = true;
  document.getElementById('errorMsg').textContent = '';
  renderHistory();

  const winnerIdx = round.indexOf(Math.max(...round));
  showToast(`âœ… ç¬¬ ${history.length} å±€å®Œæˆï¼${players[winnerIdx].toUpperCase()} +${round[winnerIdx]}`);
}

// â”€â”€ æ­·å²è¨˜éŒ„ â”€â”€
function renderHistory() {
  const c = document.getElementById('historyContainer');
  if (!history.length) {
    c.innerHTML = '<div class="empty-msg">å°šç„¡è¨˜éŒ„</div>';
    return;
  }
  c.innerHTML = `
    <table class="history-table">
      <thead><tr><th>å±€</th>${players.map(p=>`<th>${p.toUpperCase()}</th>`).join('')}</tr></thead>
      <tbody>
        ${history.slice().reverse().map((r, ri) => `
          <tr>
            <td class="round-num">#${history.length-ri}</td>
            ${r.map(v=>`<td class="${v>0?'val-pos':v<0?'val-neg':'val-zero'}">${v>0?'+':''}${v}</td>`).join('')}
          </tr>`).join('')}
        <tr style="border-top:2px solid var(--accent)">
          <td class="round-num" style="color:var(--accent);font-weight:600">åˆè¨ˆ</td>
          ${totals.map(t=>`<td class="${t>0?'val-pos':t<0?'val-neg':'val-zero'}" style="font-weight:600">${t>0?'+':''}${t}</td>`).join('')}
        </tr>
      </tbody>
    </table>`;
}

// â”€â”€ èªéŸ³è¼¸å…¥ â”€â”€
let recognition = null;
let isRecording = false;

function initVoice() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    document.getElementById('voiceStatus').textContent = 'æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³ï¼ˆå»ºè­° Chromeï¼‰';
    document.getElementById('voiceStatus').className = 'voice-status error';
    document.getElementById('voiceBtn').disabled = true;
    return;
  }
  recognition = new SR();
  recognition.lang = 'zh-TW';
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.onresult = e => {
    const t = e.results[0][0].transcript;
    setVoiceStatus(`ã€Œ${t}ã€`, 'active');
    parseVoice(t);
  };
  recognition.onerror = () => { setVoiceStatus('è¾¨è­˜å¤±æ•—ï¼Œè«‹é‡è©¦', 'error'); stopRec(); };
  recognition.onend = stopRec;
}

function toggleVoice() {
  if (isRecording) { recognition.stop(); stopRec(); }
  else startRec();
}

function startRec() {
  isRecording = true;
  recognition.start();
  document.getElementById('voiceBtn').className = 'voice-btn recording';
  document.getElementById('voiceBtn').innerHTML = 'â¹ åœæ­¢';
  setVoiceStatus('è†è½ä¸­â‹¯', 'active');
}

function stopRec() {
  isRecording = false;
  document.getElementById('voiceBtn').className = 'voice-btn';
  document.getElementById('voiceBtn').innerHTML = 'ğŸ¤ èªéŸ³';
}

function setVoiceStatus(msg, type='') {
  const el = document.getElementById('voiceStatus');
  el.textContent = msg;
  el.className = 'voice-status ' + type;
}

function parseVoice(text) {
  text = text.toLowerCase()
    .replace(/è² /g,'-').replace(/åŠ |æ­£/g,'+')
    .replace(/[ï¼Œã€,]/g,' ')
    .replace(/ä¸€/g,'1').replace(/äºŒ/g,'2').replace(/ä¸‰/g,'3')
    .replace(/å››/g,'4').replace(/äº”/g,'5').replace(/å…­/g,'6')
    .replace(/ä¸ƒ/g,'7').replace(/å…«/g,'8').replace(/ä¹/g,'9')
    .replace(/å/g,'10').replace(/ç™¾/g,'00').replace(/é›¶/g,'0');

  let matched = {};
  players.forEach((p, i) => {
    const m = text.match(new RegExp(p + '\\s*(-?\\d+)'));
    if (m) matched[i] = parseInt(m[1]);
  });

  const mIdx = Object.keys(matched).map(Number);
  if (mIdx.length === 3) {
    const emptyIdx = [0,1,2,3].filter(i => !mIdx.includes(i));
    if (emptyIdx.length === 1) {
      mIdx.forEach(i => { document.getElementById('inp-'+i).value = matched[i]; });
      document.getElementById('inp-'+emptyIdx[0]).value = '';
      updatePreview();
      setVoiceStatus('âœ… åˆ†æ•¸å·²å¡«å…¥ï¼Œç¢ºèªå¾ŒæŒ‰ã€Œç¢ºèªæ–°å¢ã€', 'success');
      return;
    }
  }

  // fallbackï¼šæŒ‰æ•¸å­—é †åºå¡«å…¥
  const nums = [...text.matchAll(/-?\d+/g)].map(m=>parseInt(m[0]));
  if (nums.filter(n=>n<0).length === 3) {
    const negNums = nums.filter(n=>n<0);
    players.forEach((_, i) => {
      document.getElementById('inp-'+i).value = i < 3 ? negNums[i] : '';
    });
    updatePreview();
    setVoiceStatus('âœ… å·²æŒ‰é †åºå¡«å…¥ï¼Œè«‹ç¢ºèªç©å®¶å°æ‡‰', 'success');
    return;
  }

  setVoiceStatus('ç„¡æ³•è§£æï¼Œè«‹èªªï¼šã€Œç©å®¶å è² æ•¸å­—ã€æ ¼å¼', 'error');
}

// â”€â”€ ä¿®æ”¹å§“å â”€â”€
function openNameModal() {
  document.getElementById('nameFields').innerHTML = players.map((p, i) => `
    <div class="modal-field">
      <label>ç©å®¶ ${i+1}</label>
      <input type="text" id="ni-${i}" value="${p}" maxlength="10">
    </div>`).join('');
  document.getElementById('nameModal').classList.add('show');
}

function quickEditName(i) {
  openNameModal();
  setTimeout(() => document.getElementById('ni-'+i)?.focus(), 100);
}

function saveNames() {
  players = players.map((p, i) => document.getElementById('ni-'+i).value.trim() || p);
  save();
  closeModal('nameModal');
  renderScoreboard();
  renderInputs();
  renderHistory();
  showToast('âœ… å§“åå·²æ›´æ–°');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

// â”€â”€ åŒ¯å‡º â”€â”€
function exportCSV() {
  if (!history.length) { showToast('âš ï¸ å°šç„¡è¨˜éŒ„'); return; }
  const headers = ['å±€', ...players.map(p=>p.toUpperCase())];
  const rows = history.map((r,i)=>[i+1,...r]);
  rows.push(['åˆè¨ˆ',...totals]);
  const csv = [headers,...rows].map(r=>r.join(',')).join('\n');
  download('\uFEFF'+csv, `è¨ˆåˆ†_${dateStr()}.csv`, 'text/csv;charset=utf-8;');
  showToast('ğŸ“¥ CSV å·²ä¸‹è¼‰');
}

function exportText() {
  if (!history.length) { showToast('âš ï¸ å°šç„¡è¨˜éŒ„'); return; }
  const lines = ['=== å››äººè¨ˆåˆ†è¨˜éŒ„ ===','','ç©å®¶ï¼š'+players.map(p=>p.toUpperCase()).join(' / '),''];
  history.forEach((r,i)=>{
    lines.push(`ç¬¬${i+1}å±€: `+players.map((p,pi)=>`${p.toUpperCase()}:${r[pi]>0?'+':''}${r[pi]}`).join('  '));
  });
  lines.push('','â”€â”€ ç´¯è¨ˆ â”€â”€');
  players.forEach((p,i)=>lines.push(`${p.toUpperCase()}: ${totals[i]>0?'+':''}${totals[i]}`));
  lines.push('','å…± '+history.length+' å±€ | '+new Date().toLocaleString('zh-TW'));
  download(lines.join('\n'), `è¨ˆåˆ†_${dateStr()}.txt`, 'text/plain;charset=utf-8;');
  showToast('ğŸ“‹ TXT å·²ä¸‹è¼‰');
}

function download(content, filename, type) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content], {type}));
  a.download = filename;
  a.click();
}

function dateStr() {
  return new Date().toLocaleDateString('zh-TW').replace(/\//g,'-');
}

function showExportMenu() {
  exportCSV();
}

// â”€â”€ æ¸…é™¤ â”€â”€
function confirmReset() {
  if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨˜éŒ„å—ï¼Ÿ')) return;
  totals = [0,0,0,0];
  history = [];
  save();
  renderScoreboard();
  renderInputs();
  document.getElementById('balanceEq').textContent = 'â€”';
  document.getElementById('btnAdd').disabled = true;
  document.getElementById('errorMsg').textContent = '';
  setVoiceStatus('é»éº¥å…‹é¢¨èªªï¼šã€Œç©å®¶å è² åˆ†ã€');
  renderHistory();
  showToast('ğŸ—‘ å·²æ¸…é™¤æ‰€æœ‰è¨˜éŒ„');
}

// â”€â”€ Toast â”€â”€
let toastTimer;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
}

init();
</script>
</body>
</html>
